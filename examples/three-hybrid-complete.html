<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Three.js AR - Complete Hybrid Demo</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #renderCanvas {
      width: 100%;
      height: 100vh;
      display: block;
    }
    #overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 10;
      max-width: 300px;
    }
    #stats {
      margin-top: 10px;
      font-size: 12px;
      opacity: 0.9;
    }
    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 8px;
      display: flex;
      gap: 10px;
      z-index: 10;
    }
    button {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    button:hover {
      background: #45a049;
    }
    button.active {
      background: #2196F3;
    }
    .status {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 5px;
    }
    .status.active {
      background: #4CAF50;
    }
    .status.inactive {
      background: #f44336;
    }
  </style>
</head>
<body>
  <canvas id="renderCanvas"></canvas>

  <div id="overlay">
    <h3 style="margin: 0 0 10px 0;">ðŸš€ Three.js Complete AR</h3>
    <div><span class="status" id="markerStatus"></span>Marker Tracking</div>
    <div><span class="status" id="planeStatus"></span>Plane Detection</div>
    <div><span class="status" id="depthStatus"></span>Depth Estimation</div>
    <div><span class="status" id="featureStatus"></span>Feature Tracking</div>
    <div id="stats"></div>
  </div>

  <div id="controls">
    <button id="toggleMarkers">Toggle Markers</button>
    <button id="togglePlanes">Toggle Planes</button>
    <button id="toggleDepth">Toggle Depth</button>
    <button id="resetTracking">Reset All</button>
  </div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { ThreeAR } from '../dist/adapters/three/three-ar.js';

    console.log('[Demo] Starting Three.js Complete AR Demo');

    // State
    let markersEnabled = true;
    let planesEnabled = true;
    let depthEnabled = false;
    let markerCount = 0;
    let planeCount = 0;
    let frameCount = 0;
    let lastTime = performance.now();
    let fps = 0;

    // Create AR with all features
    const ar = new ThreeAR({
      THREE,
      preset: 'desktop',
      enableMarkers: true,
      enablePlanes: true,
      onReady: () => {
        console.log('[Demo] AR Ready');
        updateStatus();
      },
      onMarkerDetected: (marker, anchor) => {
        markerCount++;
        console.log(`[Demo] Marker ${marker.id} detected`);

        // Create different objects for each marker
        const objects = [
          () => createCube(marker.id),
          () => createSphere(marker.id),
          () => createCylinder(marker.id),
          () => createTorus(marker.id),
        ];

        const createFunc = objects[marker.id % objects.length];
        const mesh = createFunc();
        anchor.add(mesh);

        updateStats();
      },
      onPlaneDetected: (plane, anchor) => {
        planeCount++;
        console.log(`[Demo] Plane ${plane.id} detected (${plane.orientation})`);

        if (plane.orientation === 'horizontal') {
          // Add glowing particle above plane
          const geometry = new THREE.SphereGeometry(0.02, 16, 16);
          const material = new THREE.MeshBasicMaterial({
            color: 0xffaa00,
            transparent: true,
            opacity: 0.8
          });
          const sphere = new THREE.Mesh(geometry, material);
          sphere.position.y = 0.1;
          anchor.add(sphere);

          // Animate
          function animate() {
            sphere.position.y = 0.1 + Math.sin(Date.now() * 0.003) * 0.05;
            sphere.rotation.y += 0.02;
          }
          ar.scene.userData.animations = ar.scene.userData.animations || [];
          ar.scene.userData.animations.push(animate);
        }

        updateStats();
      },
    });

    async function init() {
      try {
        await ar.start();
        console.log('[Demo] AR Started');

        // Add lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        ar.scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.4);
        directionalLight.position.set(5, 10, 7.5);
        ar.scene.add(directionalLight);

        setupControls();
        startAnimationLoop();

      } catch (error) {
        console.error('[Demo] Initialization error:', error);
        document.getElementById('overlay').innerHTML = `
          <h3>Error</h3>
          <p>${error.message}</p>
          <p>Please allow camera access and ensure WebGPU is supported.</p>
        `;
      }
    }

    function createCube(id) {
      const geometry = new THREE.BoxGeometry(0.05, 0.05, 0.05);
      const material = new THREE.MeshPhongMaterial({
        color: Math.random() * 0xffffff,
        shininess: 100
      });
      const cube = new THREE.Mesh(geometry, material);

      // Animate
      function animate() {
        cube.rotation.y += 0.01;
        cube.rotation.x += 0.005;
      }
      ar.scene.userData.animations = ar.scene.userData.animations || [];
      ar.scene.userData.animations.push(animate);

      return cube;
    }

    function createSphere(id) {
      const geometry = new THREE.SphereGeometry(0.03, 32, 32);
      const material = new THREE.MeshPhongMaterial({
        color: 0x00aaff,
        emissive: 0x002244,
        shininess: 100
      });
      const sphere = new THREE.Mesh(geometry, material);

      // Pulsing animation
      let scale = 1;
      let growing = true;
      function animate() {
        if (growing) {
          scale += 0.005;
          if (scale > 1.3) growing = false;
        } else {
          scale -= 0.005;
          if (scale < 0.7) growing = true;
        }
        sphere.scale.set(scale, scale, scale);
      }
      ar.scene.userData.animations = ar.scene.userData.animations || [];
      ar.scene.userData.animations.push(animate);

      return sphere;
    }

    function createCylinder(id) {
      const geometry = new THREE.CylinderGeometry(0.02, 0.02, 0.08, 32);
      const material = new THREE.MeshPhongMaterial({
        color: 0xff00ff,
        shininess: 80
      });
      const cylinder = new THREE.Mesh(geometry, material);

      function animate() {
        cylinder.rotation.y += 0.02;
      }
      ar.scene.userData.animations = ar.scene.userData.animations || [];
      ar.scene.userData.animations.push(animate);

      return cylinder;
    }

    function createTorus(id) {
      const geometry = new THREE.TorusGeometry(0.03, 0.01, 16, 100);
      const material = new THREE.MeshPhongMaterial({
        color: 0xffff00,
        shininess: 90
      });
      const torus = new THREE.Mesh(geometry, material);

      function animate() {
        torus.rotation.x += 0.01;
        torus.rotation.z += 0.015;
      }
      ar.scene.userData.animations = ar.scene.userData.animations || [];
      ar.scene.userData.animations.push(animate);

      return torus;
    }

    function setupControls() {
      document.getElementById('toggleMarkers').addEventListener('click', () => {
        markersEnabled = !markersEnabled;
        document.getElementById('toggleMarkers').classList.toggle('active', markersEnabled);

        const markerAnchors = ar.getAllMarkerAnchors();
        markerAnchors.forEach(anchor => {
          anchor.visible = markersEnabled;
        });

        console.log(`[Demo] Markers ${markersEnabled ? 'enabled' : 'disabled'}`);
        updateStatus();
      });

      document.getElementById('togglePlanes').addEventListener('click', () => {
        planesEnabled = !planesEnabled;
        document.getElementById('togglePlanes').classList.toggle('active', planesEnabled);

        const planeAnchors = ar.getAllPlaneAnchors();
        planeAnchors.forEach(anchor => {
          anchor.visible = planesEnabled;
        });

        console.log(`[Demo] Planes ${planesEnabled ? 'enabled' : 'disabled'}`);
        updateStatus();
      });

      document.getElementById('toggleDepth').addEventListener('click', () => {
        depthEnabled = !depthEnabled;
        document.getElementById('toggleDepth').classList.toggle('active', depthEnabled);
        console.log(`[Demo] Depth ${depthEnabled ? 'enabled' : 'disabled'} (requires stereo)`);
        updateStatus();
      });

      document.getElementById('resetTracking').addEventListener('click', () => {
        // Clear animations
        ar.scene.userData.animations = [];

        // Clear anchors
        const markerAnchors = ar.getAllMarkerAnchors();
        markerAnchors.forEach(anchor => {
          anchor.children.slice().forEach(child => {
            anchor.remove(child);
            child.geometry?.dispose();
            child.material?.dispose();
          });
        });

        const planeAnchors = ar.getAllPlaneAnchors();
        planeAnchors.forEach(anchor => {
          anchor.children.slice().forEach(child => {
            anchor.remove(child);
            child.geometry?.dispose();
            child.material?.dispose();
          });
        });

        markerCount = 0;
        planeCount = 0;

        console.log('[Demo] Tracking reset');
        updateStats();
      });
    }

    function startAnimationLoop() {
      function animate() {
        requestAnimationFrame(animate);

        // Run custom animations
        if (ar.scene.userData.animations) {
          ar.scene.userData.animations.forEach(anim => anim());
        }

        // Update FPS
        frameCount++;
        const now = performance.now();
        if (now - lastTime >= 1000) {
          fps = Math.round((frameCount * 1000) / (now - lastTime));
          frameCount = 0;
          lastTime = now;
          updateStats();
        }
      }
      animate();
    }

    function updateStatus() {
      document.getElementById('markerStatus').className = `status ${markersEnabled ? 'active' : 'inactive'}`;
      document.getElementById('planeStatus').className = `status ${planesEnabled ? 'active' : 'inactive'}`;
      document.getElementById('depthStatus').className = `status ${depthEnabled ? 'active' : 'inactive'}`;
      document.getElementById('featureStatus').className = 'status inactive';
    }

    function updateStats() {
      document.getElementById('stats').innerHTML = `
        <div>ðŸ“¦ Markers: ${markerCount}</div>
        <div>ðŸ”· Planes: ${planeCount}</div>
        <div>ðŸŽ¯ Features: 0</div>
        <div>ðŸ“Š FPS: ${fps}</div>
      `;
    }

    // Start
    init();

    // Handle window resize
    window.addEventListener('resize', () => {
      ar.resize();
    });
  </script>

  <div style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px; color: white; font-size: 12px; max-width: 250px; z-index: 10;">
    <h4 style="margin: 0 0 10px 0;">ðŸ“– Instructions</h4>
    <p>1. Allow camera access</p>
    <p>2. Show ArUco markers to camera</p>
    <p>3. Point at flat surfaces for planes</p>
    <p>4. Toggle features with buttons</p>
    <p><a href="https://github.com/opencv/opencv/tree/master/data/haarcascades" target="_blank" style="color: #4CAF50;">Download ArUco Markers</a></p>
  </div>
</body>
</html>
