<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BabylonJS AR V2 - Performance Monitor</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui; background: #1a1a1a; color: white; overflow: hidden; }
    #renderCanvas { width: 100%; height: 100vh; display: block; }
    .monitor { position: fixed; top: 20px; left: 20px; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 10px; z-index: 1000; max-width: 450px; }
    h1 { font-size: 18px; margin-bottom: 15px; color: #8BC34A; }
    .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
    .metric { padding: 15px; background: rgba(139,195,74,0.1); border-radius: 5px; text-align: center; border-top: 3px solid #8BC34A; }
    .metric-value { font-size: 28px; font-weight: bold; color: #8BC34A; }
    .metric-label { font-size: 11px; opacity: 0.7; margin-top: 5px; text-transform: uppercase; }
    .chart { height: 100px; margin: 15px 0; position: relative; }
    .chart-bar { position: absolute; bottom: 0; width: 8px; background: linear-gradient(to top, #8BC34A, #4CAF50); border-radius: 2px 2px 0 0; }
    .quality-indicator { padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; margin: 10px 0; }
    .quality-low { background: rgba(244,67,54,0.2); border: 2px solid #f44336; color: #f44336; }
    .quality-medium { background: rgba(255,193,7,0.2); border: 2px solid #FFC107; color: #FFC107; }
    .quality-high { background: rgba(76,175,80,0.2); border: 2px solid #4CAF50; color: #4CAF50; }
    .quality-ultra { background: rgba(33,150,243,0.2); border: 2px solid #2196F3; color: #2196F3; }
    .breakdown { margin: 15px 0; }
    .breakdown-item { display: flex; justify-content: space-between; padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.05); border-radius: 3px; }
    button { background: #8BC34A; color: black; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; margin: 5px 0; font-weight: bold; }
  </style>
</head>
<body>
  <canvas id="renderCanvas"></canvas>

  <div class="monitor">
    <h1>âš¡ Performance Monitor</h1>

    <div class="metrics-grid">
      <div class="metric">
        <div class="metric-value" id="fps">0</div>
        <div class="metric-label">FPS</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="frameTime">0</div>
        <div class="metric-label">Frame Time (ms)</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="gpuMemory">0</div>
        <div class="metric-label">GPU Memory (MB)</div>
      </div>
    </div>

    <div class="quality-indicator quality-high" id="qualityIndicator">
      Quality: HIGH
    </div>

    <div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:5px;margin:10px 0;">
      <h3 style="font-size:12px;margin-bottom:10px;color:#8BC34A;">FPS History</h3>
      <div class="chart" id="fpsChart"></div>
    </div>

    <div class="breakdown">
      <h3 style="font-size:12px;margin-bottom:10px;color:#8BC34A;">Frame Breakdown</h3>
      <div class="breakdown-item">
        <span>Camera Processing:</span>
        <span id="cameraTime">0ms</span>
      </div>
      <div class="breakdown-item">
        <span>GPU Processing:</span>
        <span id="gpuTime">0ms</span>
      </div>
      <div class="breakdown-item">
        <span>Tracking:</span>
        <span id="trackingTime">0ms</span>
      </div>
      <div class="breakdown-item">
        <span>Detection:</span>
        <span id="detectionTime">0ms</span>
      </div>
    </div>

    <button id="toggleQualityBtn">Toggle Quality Mode</button>
  </div>

  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script type="module">
    import { AREngine, MarkerTrackingPlugin } from '../dist/index.js';

    const canvas = document.getElementById('renderCanvas');
    const engine = new BABYLON.Engine(canvas, true);
    const scene = new BABYLON.Scene(engine);

    const camera = new BABYLON.ArcRotateCamera('camera', 0, Math.PI / 4, 10, BABYLON.Vector3.Zero(), scene);
    camera.attachControl(canvas, true);

    const light = new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);

    // FPS history for chart
    const fpsHistory = [];
    const maxHistory = 50;

    function updateFPSChart() {
      const chartDiv = document.getElementById('fpsChart');
      chartDiv.innerHTML = '';

      const maxFps = Math.max(...fpsHistory, 60);
      const barWidth = 100 / maxHistory;

      fpsHistory.forEach((fps, i) => {
        const bar = document.createElement('div');
        bar.className = 'chart-bar';
        bar.style.left = `${i * barWidth}%`;
        bar.style.height = `${(fps / maxFps) * 100}%`;

        // Color based on fps
        if (fps < 30) {
          bar.style.background = 'linear-gradient(to top, #f44336, #ff5722)';
        } else if (fps < 45) {
          bar.style.background = 'linear-gradient(to top, #FFC107, #FF9800)';
        }

        chartDiv.appendChild(bar);
      });
    }

    function updateQualityIndicator(quality) {
      const indicator = document.getElementById('qualityIndicator');
      indicator.className = `quality-indicator quality-${quality.toLowerCase()}`;
      indicator.textContent = `Quality: ${quality}`;
    }

    let currentQuality = 'HIGH';
    const qualities = ['LOW', 'MEDIUM', 'HIGH', 'ULTRA'];

    async function initAR() {
      try {
        const ar = new AREngine()
          .use(new MarkerTrackingPlugin({
            dictionary: 'ARUCO_4X4_50',
            markerSize: 0.1,
          }));

        ar.on('fps:change', (fps) => {
          document.getElementById('fps').textContent = fps;

          // Update history
          fpsHistory.push(fps);
          if (fpsHistory.length > maxHistory) {
            fpsHistory.shift();
          }
          updateFPSChart();

          // Calculate frame time
          const frameTime = fps > 0 ? (1000 / fps).toFixed(1) : 0;
          document.getElementById('frameTime').textContent = frameTime;
        });

        ar.on('performance', (metrics) => {
          // Update breakdown (simulated for demo)
          if (metrics.breakdown) {
            document.getElementById('cameraTime').textContent = `${metrics.breakdown.camera || 0}ms`;
            document.getElementById('gpuTime').textContent = `${metrics.breakdown.gpu || 0}ms`;
            document.getElementById('trackingTime').textContent = `${metrics.breakdown.tracking || 0}ms`;
            document.getElementById('detectionTime').textContent = `${metrics.breakdown.detection || 0}ms`;
          }

          // Update GPU memory (simulated)
          if (metrics.memoryUsage) {
            document.getElementById('gpuMemory').textContent = metrics.memoryUsage.gpu || 0;
          }
        });

        ar.on('marker:detected', (marker) => {
          console.log(`Marker ${marker.id} detected`);
        });

        ar.on('error', (error) => {
          console.error('AR Error:', error);
        });

        await ar.initialize();
        await ar.start();

        engine.runRenderLoop(() => {
          scene.render();

          // Simulate some performance metrics
          const fps = engine.getFps();
          document.getElementById('fps').textContent = Math.round(fps);

          // Simulate breakdown (for demo purposes)
          document.getElementById('cameraTime').textContent = (Math.random() * 5 + 2).toFixed(1) + 'ms';
          document.getElementById('gpuTime').textContent = (Math.random() * 8 + 5).toFixed(1) + 'ms';
          document.getElementById('trackingTime').textContent = (Math.random() * 3 + 1).toFixed(1) + 'ms';
          document.getElementById('detectionTime').textContent = (Math.random() * 6 + 3).toFixed(1) + 'ms';

          // Simulate GPU memory
          document.getElementById('gpuMemory').textContent = Math.round(Math.random() * 50 + 80);
        });

        return ar;
      } catch (error) {
        console.error('Failed to initialize:', error);
      }
    }

    document.getElementById('toggleQualityBtn').addEventListener('click', () => {
      const currentIndex = qualities.indexOf(currentQuality);
      const nextIndex = (currentIndex + 1) % qualities.length;
      currentQuality = qualities[nextIndex];
      updateQualityIndicator(currentQuality);
    });

    initAR();
    updateQualityIndicator(currentQuality);
    window.addEventListener('resize', () => engine.resize());
  </script>
</body>
</html>
