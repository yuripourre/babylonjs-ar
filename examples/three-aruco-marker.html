<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Three.js AR - ArUco Marker Example</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a1a;
      color: white;
      overflow: hidden;
    }

    #renderCanvas {
      width: 100%;
      height: 100vh;
      display: block;
    }

    .controls {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 10px;
      z-index: 1000;
      max-width: 350px;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 15px;
      color: #00d9ff;
    }

    .status {
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .status.info { background: rgba(0, 150, 255, 0.2); border: 1px solid #0096ff; }
    .status.success { background: rgba(0, 255, 0, 0.2); border: 1px solid #00ff00; }
    .status.error { background: rgba(255, 0, 0, 0.2); border: 1px solid #ff0000; }

    .instructions {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 5px;
      font-size: 13px;
      line-height: 1.6;
      margin-top: 15px;
    }

    .instructions h3 {
      font-size: 14px;
      margin-bottom: 10px;
      color: #00d9ff;
    }

    .instructions ol {
      margin-left: 20px;
    }

    .instructions li {
      margin-bottom: 8px;
    }

    .instructions a {
      color: #00d9ff;
      text-decoration: none;
    }

    .instructions a:hover {
      text-decoration: underline;
    }

    .marker-info {
      margin-top: 15px;
      padding: 10px;
      background: rgba(0, 217, 255, 0.1);
      border-radius: 5px;
      font-size: 13px;
    }

    .marker-info h4 {
      color: #00d9ff;
      margin-bottom: 8px;
    }

    .marker-item {
      padding: 8px;
      margin: 5px 0;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 3px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .marker-id {
      font-weight: bold;
      color: #00ff00;
    }

    button {
      background: #00d9ff;
      color: black;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      margin-top: 10px;
      width: 100%;
    }

    button:hover {
      background: #00b8dd;
    }

    button:active {
      transform: scale(0.98);
    }
  </style>
</head>
<body>
  <canvas id="renderCanvas"></canvas>

  <div class="controls">
    <h1>üéØ ArUco Marker AR (Three.js)</h1>
    <div id="status" class="status info">Initializing...</div>

    <div class="marker-info">
      <h4>üìç Detected Markers:</h4>
      <div id="markerList">No markers detected</div>
    </div>

    <div class="instructions">
      <h3>üìã How to Use:</h3>
      <ol>
        <li>Print an ArUco marker from <a href="https://chev.me/arucogen/" target="_blank">ArUco Generator</a></li>
        <li>Use <strong>4x4 Dictionary</strong>, IDs 0-49</li>
        <li>Point your camera at the marker</li>
        <li>A 3D cube will appear on the marker!</li>
      </ol>

      <p style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
        üí° Tip: Keep marker flat and well-lit for best results
      </p>
    </div>

    <button onclick="downloadMarker()">‚¨áÔ∏è Download Test Marker</button>
  </div>

  <!-- Three.js -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { ThreeAR } from '../dist/adapters/three/three-ar.js';

    // Status updates
    function updateStatus(message, type = 'info') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // Update marker list
    function updateMarkerList(markers) {
      const listEl = document.getElementById('markerList');

      if (markers.length === 0) {
        listEl.innerHTML = '<div style="opacity: 0.6;">No markers detected</div>';
        return;
      }

      listEl.innerHTML = markers.map(m => `
        <div class="marker-item">
          <span>
            <span class="marker-id">Marker ${m.id}</span>
            <span style="font-size: 11px; opacity: 0.8;">(${(m.confidence * 100).toFixed(0)}%)</span>
          </span>
          <span style="color: #00ff00;">‚úì</span>
        </div>
      `).join('');
    }

    // Store marker cubes
    const markerCubes = new Map();

    // Create 3D cube for marker
    function createMarkerCube(markerId, anchor) {
      // Create colorful cube
      const geometry = new THREE.BoxGeometry(0.05, 0.05, 0.05); // 5cm cube
      const material = new THREE.MeshBasicMaterial({
        color: new THREE.Color(Math.random(), Math.random(), Math.random()),
        wireframe: false,
      });

      const cube = new THREE.Mesh(geometry, material);

      // Add to anchor
      anchor.add(cube);
      markerCubes.set(markerId, cube);

      console.log(`Created cube for marker ${markerId}`);
    }

    // Main AR setup
    async function initAR() {
      try {
        updateStatus('Checking WebGPU support...', 'info');

        if (!navigator.gpu) {
          throw new Error('WebGPU not supported. Use Chrome 113+ or Edge 113+');
        }

        updateStatus('Initializing AR engine...', 'info');

        // Create AR engine with marker tracking
        const ar = new ThreeAR({
          THREE,
          preset: 'desktop',
          enableMarkers: true,
          onMarkerDetected: (marker, anchor) => {
            createMarkerCube(marker.id, anchor);
            updateStatus(`‚ú® Found marker ${marker.id}!`, 'success');
          },
        });

        await ar.start();

        // Track markers in frame callback
        ar.arEngine.start((frame) => {
          if (frame.markers && frame.markers.length > 0) {
            updateMarkerList(frame.markers);

            // Animate cubes
            for (const [id, cube] of markerCubes) {
              cube.rotation.y += 0.02;
              cube.rotation.x += 0.01;
            }
          } else {
            updateMarkerList([]);
          }
        });

        updateStatus('‚úÖ AR Running! Show a marker to the camera', 'success');

        // Handle window resize
        window.addEventListener('resize', () => ar.resize());

      } catch (error) {
        console.error('Failed to initialize AR:', error);
        updateStatus(`Error: ${error.message}`, 'error');
      }
    }

    // Download test marker
    window.downloadMarker = function() {
      const canvas = document.createElement('canvas');
      canvas.width = 400;
      canvas.height = 400;
      const ctx = canvas.getContext('2d');

      // White background
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, 400, 400);

      // Black border
      ctx.fillStyle = 'black';
      ctx.fillRect(50, 50, 300, 300);

      // White inner border
      ctx.fillStyle = 'white';
      ctx.fillRect(75, 75, 250, 250);

      // Simple 4x4 marker pattern (marker ID 0)
      const cellSize = 50;
      const pattern = [
        [0, 0, 0, 0],
        [0, 1, 1, 0],
        [0, 1, 1, 0],
        [0, 0, 0, 0],
      ];

      ctx.fillStyle = 'black';
      for (let y = 0; y < 4; y++) {
        for (let x = 0; x < 4; x++) {
          if (pattern[y][x] === 1) {
            ctx.fillRect(87.5 + x * cellSize, 87.5 + y * cellSize, cellSize, cellSize);
          }
        }
      }

      // Add text
      ctx.font = 'bold 20px Arial';
      ctx.fillStyle = 'black';
      ctx.textAlign = 'center';
      ctx.fillText('ArUco Marker ID: 0', 200, 380);

      // Download
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'aruco-marker-0.png';
        a.click();
        URL.revokeObjectURL(url);

        updateStatus('‚úÖ Marker downloaded! Print it to use.', 'success');
      });
    };

    // Start when page loads
    initAR();
  </script>
</body>
</html>
