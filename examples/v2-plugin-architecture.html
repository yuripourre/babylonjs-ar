<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Engine V2 - Plugin Architecture Demo</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a1a;
      color: #fff;
    }

    h1 {
      margin: 0 0 20px 0;
      color: #4CAF50;
    }

    #container {
      display: flex;
      gap: 20px;
    }

    #video-container {
      flex: 1;
      position: relative;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }

    video {
      width: 100%;
      height: auto;
      display: block;
    }

    #controls {
      width: 350px;
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
    }

    .section {
      margin-bottom: 20px;
      padding: 15px;
      background: #333;
      border-radius: 4px;
    }

    .section h3 {
      margin: 0 0 10px 0;
      color: #4CAF50;
      font-size: 14px;
      text-transform: uppercase;
    }

    button {
      width: 100%;
      padding: 12px;
      margin: 5px 0;
      background: #4CAF50;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    button:hover:not(:disabled) {
      background: #45a049;
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      margin: 10px 0;
      padding: 8px;
      background: #444;
      border-radius: 4px;
    }

    .checkbox-group input {
      margin-right: 10px;
    }

    .stat {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #444;
    }

    .stat:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: #aaa;
    }

    .stat-value {
      color: #4CAF50;
      font-weight: bold;
    }

    #log {
      height: 200px;
      overflow-y: auto;
      background: #1a1a1a;
      padding: 10px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .log-entry {
      margin: 2px 0;
    }

    .log-info { color: #4CAF50; }
    .log-warn { color: #FFC107; }
    .log-error { color: #f44336; }

    .status {
      padding: 10px;
      border-radius: 4px;
      text-align: center;
      margin-bottom: 15px;
    }

    .status-ready { background: #4CAF50; }
    .status-running { background: #2196F3; }
    .status-error { background: #f44336; }
  </style>
</head>
<body>
  <h1>ðŸš€ AR Engine V2 - Plugin Architecture</h1>

  <div id="container">
    <div id="video-container">
      <video id="video" autoplay playsinline></video>
    </div>

    <div id="controls">
      <div class="status status-ready" id="status">Ready to start</div>

      <div class="section">
        <h3>Engine Controls</h3>
        <button id="startBtn">Initialize & Start</button>
        <button id="stopBtn" disabled>Stop</button>
        <button id="destroyBtn" disabled>Destroy</button>
      </div>

      <div class="section">
        <h3>Plugins</h3>
        <div class="checkbox-group">
          <input type="checkbox" id="markerPlugin" checked>
          <label for="markerPlugin">Marker Tracking</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="depthPlugin" checked>
          <label for="depthPlugin">Depth Estimation</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="meshPlugin">
          <label for="meshPlugin">Mesh Reconstruction</label>
        </div>
      </div>

      <div class="section">
        <h3>Statistics</h3>
        <div class="stat">
          <span class="stat-label">FPS:</span>
          <span class="stat-value" id="fps">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">Frame Count:</span>
          <span class="stat-value" id="frameCount">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">Plugins:</span>
          <span class="stat-value" id="pluginCount">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">Markers:</span>
          <span class="stat-value" id="markerCount">0</span>
        </div>
      </div>

      <div class="section">
        <h3>Event Log</h3>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { AREngineV2 } from '../dist/babylonjs-ar.js';
    import {
      MarkerTrackingPlugin,
      DepthEstimationPlugin,
      MeshReconstructionPlugin
    } from '../dist/plugins/index.js';

    // UI Elements
    const video = document.getElementById('video');
    const status = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const destroyBtn = document.getElementById('destroyBtn');
    const logDiv = document.getElementById('log');

    // State
    let ar = null;
    let markerCount = 0;

    // Logging
    function addLog(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;

      // Keep only last 50 entries
      while (logDiv.children.length > 50) {
        logDiv.removeChild(logDiv.firstChild);
      }
    }

    // Status
    function setStatus(text, className) {
      status.textContent = text;
      status.className = `status ${className}`;
    }

    // Initialize and start
    async function initializeAndStart() {
      try {
        addLog('Creating AR Engine V2...', 'info');
        setStatus('Initializing...', 'status-running');

        // Create AR engine
        ar = new AREngineV2();

        // Register selected plugins
        if (document.getElementById('markerPlugin').checked) {
          ar.use(new MarkerTrackingPlugin({
            dictionary: 'ARUCO_4X4_50',
            markerSize: 0.1,
          }));
          addLog('âœ“ Marker tracking plugin registered', 'info');
        }

        if (document.getElementById('depthPlugin').checked) {
          ar.use(new DepthEstimationPlugin({
            quality: 'medium',
            inferenceInterval: 100,
          }));
          addLog('âœ“ Depth estimation plugin registered', 'info');
        }

        if (document.getElementById('meshPlugin').checked) {
          ar.use(new MeshReconstructionPlugin({
            voxelSize: 0.01,
            extractionInterval: 30,
          }));
          addLog('âœ“ Mesh reconstruction plugin registered', 'info');
        }

        // Setup event listeners
        ar.on('ready', () => {
          addLog('ðŸŽ‰ AR engine ready!', 'info');
          setStatus('Running', 'status-running');
        });

        ar.on('frame', (frame) => {
          document.getElementById('frameCount').textContent = frame.timestamp;
        });

        ar.on('fps:change', (fps) => {
          document.getElementById('fps').textContent = fps;
        });

        ar.on('marker:detected', (marker) => {
          markerCount++;
          document.getElementById('markerCount').textContent = markerCount;
          addLog(`Marker detected: ID ${marker.id}`, 'info');
        });

        ar.on('depth:available', (depthMap) => {
          addLog(`Depth: ${depthMap.width}x${depthMap.height}`, 'info');
        });

        ar.on('mesh:updated', (mesh) => {
          addLog(`Mesh: ${mesh.vertices.length} vertices`, 'info');
        });

        ar.on('error', (error) => {
          addLog(`Error: ${error.message}`, 'error');
          if (error.code) {
            addLog(`Code: ${error.code}`, 'error');
          }
        });

        ar.on('warning', (message) => {
          addLog(message, 'warn');
        });

        // Initialize
        addLog('Initializing...', 'info');
        await ar.initialize({
          gpu: { powerPreference: 'high-performance' },
        });

        // Update stats
        const stats = ar.getStats();
        document.getElementById('pluginCount').textContent = stats.plugins.totalPlugins;

        // Start
        addLog('Starting AR processing...', 'info');
        await ar.start();

        // Update UI
        startBtn.disabled = true;
        stopBtn.disabled = false;
        destroyBtn.disabled = false;

        setStatus('Running', 'status-running');
        addLog('âœ“ AR engine started successfully', 'info');

      } catch (error) {
        addLog(`Initialization failed: ${error.message}`, 'error');
        setStatus('Error', 'status-error');

        if (error.suggestions) {
          for (const suggestion of error.suggestions) {
            addLog(`ðŸ’¡ ${suggestion.message}`, 'warn');
          }
        }
      }
    }

    // Stop
    function stop() {
      if (ar) {
        ar.stop();
        addLog('AR engine stopped', 'info');
        setStatus('Stopped', 'status-ready');
        stopBtn.disabled = true;
      }
    }

    // Destroy
    async function destroy() {
      if (ar) {
        await ar.destroy();
        ar = null;
        addLog('AR engine destroyed', 'info');
        setStatus('Destroyed', 'status-ready');

        startBtn.disabled = false;
        stopBtn.disabled = true;
        destroyBtn.disabled = true;

        // Reset stats
        document.getElementById('frameCount').textContent = '0';
        document.getElementById('fps').textContent = '0';
        document.getElementById('pluginCount').textContent = '0';
        markerCount = 0;
        document.getElementById('markerCount').textContent = '0';
      }
    }

    // Event listeners
    startBtn.addEventListener('click', initializeAndStart);
    stopBtn.addEventListener('click', stop);
    destroyBtn.addEventListener('click', destroy);

    // Initial log
    addLog('AR Engine V2 - Plugin Architecture Demo', 'info');
    addLog('Select plugins and click "Initialize & Start"', 'info');
  </script>
</body>
</html>
