<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Engine V2 - Plugin Architecture Demo</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui; background: #1a1a1a; color: white; padding: 20px; }
    h1 { margin-bottom: 20px; color: #4CAF50; }
    #container { display: flex; gap: 20px; }
    #controls { width: 350px; background: #2a2a2a; padding: 20px; border-radius: 8px; }
    .section { margin-bottom: 20px; padding: 15px; background: #333; border-radius: 4px; }
    .section h3 { margin: 0 0 10px 0; color: #4CAF50; font-size: 14px; text-transform: uppercase; }
    button { width: 100%; padding: 12px; margin: 5px 0; background: #4CAF50; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px; }
    button:hover:not(:disabled) { background: #45a049; }
    button:disabled { background: #666; cursor: not-allowed; }
    .checkbox-group { display: flex; align-items: center; margin: 10px 0; padding: 8px; background: #444; border-radius: 4px; }
    .stat { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #444; }
    .stat-label { color: #aaa; }
    .stat-value { color: #4CAF50; font-weight: bold; }
    #log { height: 200px; overflow-y: auto; background: #1a1a1a; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; }
    .log-entry { margin: 2px 0; }
    .log-info { color: #4CAF50; }
    .log-warn { color: #FFC107; }
    .log-error { color: #f44336; }
    .status { padding: 10px; border-radius: 4px; text-align: center; margin-bottom: 15px; }
    .status-ready { background: #4CAF50; }
    .status-running { background: #2196F3; }
    .status-error { background: #f44336; }
  </style>
</head>
<body>
  <h1>ðŸš€ AR Engine V2 - Plugin Architecture</h1>

  <div id="container">
    <div id="controls">
      <div class="status status-ready" id="status">Ready to start</div>

      <div class="section">
        <h3>Engine Controls</h3>
        <button id="startBtn">Initialize & Start</button>
        <button id="stopBtn" disabled>Stop</button>
        <button id="destroyBtn" disabled>Destroy</button>
      </div>

      <div class="section">
        <h3>Plugins</h3>
        <div class="checkbox-group">
          <input type="checkbox" id="markerPlugin" checked>
          <label for="markerPlugin">Marker Tracking</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="depthPlugin" checked>
          <label for="depthPlugin">Depth Estimation</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="meshPlugin">
          <label for="meshPlugin">Mesh Reconstruction</label>
        </div>
      </div>

      <div class="section">
        <h3>Statistics</h3>
        <div class="stat">
          <span class="stat-label">FPS:</span>
          <span class="stat-value" id="fps">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">Frame Count:</span>
          <span class="stat-value" id="frameCount">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">Plugins:</span>
          <span class="stat-value" id="pluginCount">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">Markers:</span>
          <span class="stat-value" id="markerCount">0</span>
        </div>
      </div>

      <div class="section">
        <h3>Event Log</h3>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { AREngine, MarkerTrackingPlugin, DepthEstimationPlugin, MeshReconstructionPlugin } from '../dist/index.js';

    const status = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const destroyBtn = document.getElementById('destroyBtn');
    const logDiv = document.getElementById('log');

    let ar = null;
    let markerCount = 0;

    function addLog(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;

      while (logDiv.children.length > 50) {
        logDiv.removeChild(logDiv.firstChild);
      }
    }

    function setStatus(text, className) {
      status.textContent = text;
      status.className = `status ${className}`;
    }

    async function initializeAndStart() {
      try {
        addLog('Creating AR Engine V2...', 'info');
        setStatus('Initializing...', 'status-running');

        ar = new AREngine();

        if (document.getElementById('markerPlugin').checked) {
          ar.use(new MarkerTrackingPlugin({
            dictionary: 'ARUCO_4X4_50',
            markerSize: 0.1,
          }));
          addLog('âœ“ Marker tracking plugin registered', 'info');
        }

        if (document.getElementById('depthPlugin').checked) {
          ar.use(new DepthEstimationPlugin({
            quality: 'medium',
            inferenceInterval: 100,
          }));
          addLog('âœ“ Depth estimation plugin registered', 'info');
        }

        if (document.getElementById('meshPlugin').checked) {
          ar.use(new MeshReconstructionPlugin({
            voxelSize: 0.01,
            extractionInterval: 30,
          }));
          addLog('âœ“ Mesh reconstruction plugin registered', 'info');
        }

        ar.on('ready', () => {
          addLog('ðŸŽ‰ AR engine ready!', 'info');
          setStatus('Running', 'status-running');
        });

        ar.on('frame', (frame) => {
          document.getElementById('frameCount').textContent = frame.timestamp;
        });

        ar.on('fps:change', (fps) => {
          document.getElementById('fps').textContent = fps;
        });

        ar.on('marker:detected', (marker) => {
          markerCount++;
          document.getElementById('markerCount').textContent = markerCount;
          addLog(`Marker detected: ID ${marker.id}`, 'info');
        });

        ar.on('depth:available', (depthMap) => {
          addLog(`Depth: ${depthMap.width}x${depthMap.height}`, 'info');
        });

        ar.on('mesh:updated', (mesh) => {
          addLog(`Mesh: ${mesh.vertices.length} vertices`, 'info');
        });

        ar.on('error', (error) => {
          addLog(`Error: ${error.message}`, 'error');
          if (error.code) {
            addLog(`Code: ${error.code}`, 'error');
          }
        });

        ar.on('warning', (message) => {
          addLog(message, 'warn');
        });

        addLog('Initializing...', 'info');
        await ar.initialize();

        const pluginManager = ar.getPluginManager?.() || { getPlugins: () => [] };
        const plugins = pluginManager.getPlugins?.() || [];
        document.getElementById('pluginCount').textContent = plugins.length;

        addLog('Starting AR processing...', 'info');
        await ar.start();

        startBtn.disabled = true;
        stopBtn.disabled = false;
        destroyBtn.disabled = false;

        setStatus('Running', 'status-running');
        addLog('âœ“ AR engine started successfully', 'info');

      } catch (error) {
        addLog(`Initialization failed: ${error.message}`, 'error');
        setStatus('Error', 'status-error');

        if (error.suggestions) {
          for (const suggestion of error.suggestions) {
            addLog(`ðŸ’¡ ${suggestion.message}`, 'warn');
          }
        }
      }
    }

    function stop() {
      if (ar) {
        ar.stop();
        addLog('AR engine stopped', 'info');
        setStatus('Stopped', 'status-ready');
        stopBtn.disabled = true;
      }
    }

    async function destroy() {
      if (ar) {
        await ar.destroy();
        ar = null;
        addLog('AR engine destroyed', 'info');
        setStatus('Destroyed', 'status-ready');

        startBtn.disabled = false;
        stopBtn.disabled = true;
        destroyBtn.disabled = true;

        document.getElementById('frameCount').textContent = '0';
        document.getElementById('fps').textContent = '0';
        document.getElementById('pluginCount').textContent = '0';
        markerCount = 0;
        document.getElementById('markerCount').textContent = '0';
      }
    }

    startBtn.addEventListener('click', initializeAndStart);
    stopBtn.addEventListener('click', stop);
    destroyBtn.addEventListener('click', destroy);

    addLog('AR Engine V2 - Plugin Architecture Demo', 'info');
    addLog('Select plugins and click "Initialize & Start"', 'info');
  </script>
</body>
</html>
